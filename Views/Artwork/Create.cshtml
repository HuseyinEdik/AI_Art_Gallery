@model AI_Art_Gallery.Models.Artwork

@{
    ViewData["Title"] = "Eser Paylaş";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-lg border-0 rounded-4 mt-4" style="background-color: #1e1e1e;">
            <div class="card-header bg-transparent border-0 pt-4 pb-2 text-center">
                <h2 class="text-white fw-bold"><i class="fa-solid fa-cloud-arrow-up me-2"></i>Eser Paylaş</h2>
                <p class="text-secondary">Yapay zeka ile ürettiğin görseli paylaş.</p>
            </div>

            <div class="card-body p-4">
                <form asp-action="Create" method="post" enctype="multipart/form-data">

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-4">
                        <label asp-for="Title" class="form-label text-white fw-semibold">Görsel Başlığı</label>
                        <input asp-for="Title" class="form-control bg-dark text-white border-secondary" placeholder="Örn: Karlı Dağlar" />
                        <span asp-validation-for="Title" class="text-danger small"></span>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-white fw-semibold">Görsel Dosyası</label>
                        <input type="file" name="imageFile" id="imageFile" class="form-control bg-dark text-white border-secondary" accept="image/*" required />
                        <div class="form-text text-secondary small mt-1">
                            <i class="fa-solid fa-info-circle me-1"></i> Maksimum dosya boyutu: 10 MB
                        </div>
                        <div id="fileSizeError" class="text-danger small mt-1" style="display: none;">
                            <i class="fa-solid fa-exclamation-triangle me-1"></i> Dosya boyutu 10 MB'dan küçük olmalıdır!
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-white fw-semibold mb-3">
                            <i class="fa-solid fa-tags me-2"></i>Kategoriler
                        </label>

                        <div class="card bg-dark border-secondary p-3" style="border-radius: 10px;">
                            <div class="row g-3" style="max-height: 250px; overflow-y: auto;">

                                @if (ViewBag.Categories != null)
                                {
                                    foreach (var cat in ViewBag.Categories)
                                    {
                                        <div class="col-12 col-sm-6 col-md-4">
                                            <div class="category-item p-3 rounded-3 border border-secondary d-flex align-items-center">
                                                <input class="form-check-input category-checkbox me-3 flex-shrink-0"
                                                       type="checkbox"
                                                       name="selectedCategoryIds"
                                                       value="@cat.Id"
                                                       id="cat_@cat.Id"
                                                       style="width: 20px; height: 20px; cursor: pointer;">
                                                <label class="form-check-label text-white fw-semibold mb-0 w-100" 
                                                       for="cat_@cat.Id" 
                                                       style="cursor: pointer; user-select: none;">
                                                    @cat.Name
                                                </label>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="col-12">
                                        <div class="text-warning small text-center p-3">
                                            <i class="fa-solid fa-exclamation-triangle me-2"></i>Kategoriler yüklenemedi.
                                        </div>
                                    </div>
                                }

                            </div>
                        </div>
                        <div class="form-text text-secondary small mt-2">
                            <i class="fa-solid fa-check-double me-1"></i> İstediğiniz kadar kategori seçebilirsiniz.
                            <span id="selectedCount" class="badge bg-primary ms-2">0 seçili</span>
                        </div>
                    </div>

                    <style>
                        .category-item {
                            background-color: #2c2c2c;
                            transition: all 0.3s ease;
                            cursor: pointer;
                            min-height: 50px;
                        }

                        .category-item:hover {
                            background-color: #3d3d3d;
                            border-color: #bb86fc !important;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(187, 134, 252, 0.2);
                        }

                        .category-checkbox:checked {
                            background-color: #bb86fc !important;
                            border-color: #bb86fc !important;
                        }

                        .category-checkbox:checked ~ label {
                            color: #bb86fc !important;
                            font-weight: bold;
                        }

                        .category-item:has(.category-checkbox:checked) {
                            background-color: rgba(187, 134, 252, 0.1);
                            border-color: #bb86fc !important;
                        }

                        /* Scrollbar styling */
                        .card::-webkit-scrollbar {
                            width: 8px;
                        }

                        .card::-webkit-scrollbar-track {
                            background: #1e1e1e;
                            border-radius: 10px;
                        }

                        .card::-webkit-scrollbar-thumb {
                            background: #bb86fc;
                            border-radius: 10px;
                        }

                        .card::-webkit-scrollbar-thumb:hover {
                            background: #9965f4;
                        }
                    </style>

                    <div class="mb-4">
                        <label asp-for="PromptText" class="form-label text-white fw-semibold">Prompt (Komut)</label>
                        <textarea asp-for="PromptText" class="form-control bg-dark text-white border-secondary" rows="4" placeholder="Görseli oluşturmak için kullandığın komutu buraya yapıştır..."></textarea>
                        <span asp-validation-for="PromptText" class="text-danger small"></span>
                    </div>

                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" class="btn btn-primary-custom btn-lg rounded-pill fw-bold">
                            🚀 Paylaş ve Yayınla
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary rounded-pill">İptal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    
    <script>
        // Kategori seçim sayacı
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.category-checkbox');
            const countBadge = document.getElementById('selectedCount');
            const fileInput = document.getElementById('imageFile');
            const form = document.querySelector('form');
            const fileSizeError = document.getElementById('fileSizeError');
            
            // Dosya boyutu kontrolü (10 MB = 10 * 1024 * 1024 bytes)
            const MAX_FILE_SIZE = 10 * 1024 * 1024;
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    
                    console.log('File selected:', file.name);
                    console.log('File size:', fileSizeMB, 'MB');
                    
                    if (file.size > MAX_FILE_SIZE) {
                        fileSizeError.style.display = 'block';
                        this.value = ''; // Dosyayı temizle
                        alert(`Dosya boyutu çok büyük: ${fileSizeMB} MB\nMaksimum izin verilen: 10 MB`);
                    } else {
                        fileSizeError.style.display = 'none';
                    }
                }
            });
            
            function updateCount() {
                const checkedCount = document.querySelectorAll('.category-checkbox:checked').length;
                countBadge.textContent = checkedCount + ' seçili';
                
                // Debug
                console.log('=== CATEGORY SELECTION ===');
                console.log('Total categories:', checkboxes.length);
                console.log('Selected categories:', checkedCount);
                
                const selectedIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                    .map(cb => cb.value);
                console.log('Selected IDs:', selectedIds.join(', '));
            }
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCount);
            });
            
            // Form submit olduğunda da log
            form.addEventListener('submit', function(e) {
                // Dosya boyutu kontrolü
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.size > MAX_FILE_SIZE) {
                        e.preventDefault();
                        alert('Lütfen 10 MB\'dan küçük bir dosya seçin!');
                        return false;
                    }
                }
                
                const selectedIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                    .map(cb => cb.value);
                console.log('=== FORM SUBMIT ===');
                console.log('Submitting with categories:', selectedIds.join(', '));
            });
        });
    </script>
}